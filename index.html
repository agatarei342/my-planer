<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Planner 2025</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Caveat:wght@400;600;700&family=Kalam:wght@300;400;700&display=swap');

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background: #f5f0e8;
            font-family: 'Caveat', cursive;
            min-height: 100vh;
            padding: 30px 20px;
            background-image: 
                radial-gradient(circle at 20% 50%, rgba(255,200,150,0.08) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(150,200,255,0.08) 0%, transparent 50%);
        }

        body::before {
            content: '';
            position: fixed;
            top: 60px; right: 40px;
            width: 80px; height: 80px;
            border-radius: 50%;
            border: 3px solid rgba(139,90,43,0.12);
            box-shadow: inset 0 0 15px rgba(139,90,43,0.08);
            pointer-events: none;
            z-index: 0;
        }

        .notebook {
            max-width: 980px;
            margin: 0 auto;
            background: #fffef9;
            border-radius: 4px;
            box-shadow: 4px 4px 0px #e0d5c0, 8px 8px 0px #d4c9b0, 0 20px 60px rgba(0,0,0,0.12);
            position: relative;
            overflow: hidden;
        }

        .spiral {
            position: absolute;
            left: 0; top: 0;
            width: 36px;
            height: 100%;
            background: #f0ebe0;
            border-right: 2px dashed #d4c9b0;
            z-index: 10;
        }
        .spiral::before {
            content: '‚¨§\A‚¨§\A‚¨§\A‚¨§\A‚¨§\A‚¨§\A‚¨§\A‚¨§\A‚¨§\A‚¨§\A‚¨§\A‚¨§\A‚¨§\A‚¨§\A‚¨§\A‚¨§\A‚¨§\A‚¨§\A‚¨§\A‚¨§';
            white-space: pre;
            position: absolute;
            left: 50%; transform: translateX(-50%);
            top: 20px;
            font-size: 10px;
            color: #b5a898;
            line-height: 2.2;
        }

        .content {
            padding: 30px 30px 30px 54px;
            position: relative;
        }

        .content::before {
            content: '';
            position: absolute;
            inset: 0;
            background-image: repeating-linear-gradient(transparent, transparent 31px, #e8e0d0 31px, #e8e0d0 32px);
            pointer-events: none;
            opacity: 0.4;
        }

        /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 28px;
            position: relative;
            z-index: 1;
            flex-wrap: wrap;
            gap: 10px;
        }

        .nav-btn {
            font-family: 'Caveat', cursive;
            font-size: 22px;
            background: none;
            border: 2px solid #d4c9b0;
            border-radius: 50%;
            width: 38px; height: 38px;
            cursor: pointer;
            color: #8b7b6a;
            transition: all 0.2s;
            display: flex; align-items: center; justify-content: center;
        }
        .nav-btn:hover { background: #ff9a9e; border-color: #ff9a9e; color: white; }

        .header-center { text-align: center; }

        .month-banner {
            display: inline-block;
            background: linear-gradient(135deg, #ff9a9e, #fecfef);
            padding: 8px 40px;
            border-radius: 2px;
            transform: rotate(-1deg);
            box-shadow: 3px 3px 0 rgba(0,0,0,0.1);
            position: relative;
        }
        .month-banner::before, .month-banner::after {
            content: 'üìå';
            position: absolute;
            top: -8px; font-size: 16px;
        }
        .month-banner::before { left: 8px; transform: rotate(-15deg); }
        .month-banner::after  { right: 8px; transform: rotate(15deg); }

        .month-title { font-size: 30px; font-weight: 700; color: #5d3a5a; letter-spacing: 2px; }
        .year-tag    { font-size: 13px; color: #8b6b8a; margin-top: 4px; }

        /* today button */
        .today-btn {
            font-family: 'Caveat', cursive;
            font-size: 14px;
            padding: 5px 14px;
            background: #fffef9;
            border: 1.5px solid #d4c9b0;
            border-radius: 20px;
            cursor: pointer;
            color: #8b7b6a;
            transition: all 0.2s;
        }
        .today-btn:hover { background: #ff9a9e; border-color: #ff9a9e; color: white; }

        /* washi */
        .washi {
            position: absolute;
            height: 22px;
            opacity: 0.7;
            z-index: 5;
        }
        .washi-1 {
            background: repeating-linear-gradient(45deg,#a8d8ea,#a8d8ea 5px,#87ceeb 5px,#87ceeb 10px);
            width: 90px; top: 12px; left: 54px;
            transform: rotate(-2deg);
        }
        .washi-2 {
            background: repeating-linear-gradient(45deg,#ffd3b6,#ffd3b6 5px,#ffb347 5px,#ffb347 10px);
            width: 80px; top: 8px; right: 20px;
            transform: rotate(3deg);
        }

        /* ‚îÄ‚îÄ Calendar Grid ‚îÄ‚îÄ */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            position: relative;
            z-index: 1;
        }

        .day-header {
            text-align: center;
            font-size: 13px;
            font-weight: 700;
            padding: 4px;
            color: #999;
            letter-spacing: 1px;
        }
        .day-header.weekend { color: #e07b7b; }

        /* ‚îÄ‚îÄ Day Card ‚îÄ‚îÄ */
        .day-card {
            min-height: 110px;
            background: rgba(255,255,255,0.4);
            border-radius: 3px;
            padding: 6px;
            position: relative;
            border: 1px solid transparent;
            transition: border-color 0.15s, background 0.15s;
        }
        .day-card:hover { border-color: #e8ddd0; background: rgba(255,255,255,0.7); }
        .day-card.today { background: rgba(255,154,158,0.08); border-color: #ff9a9e; }
        .day-card.weekend .day-number { color: #e07b7b; }
        .day-card.other-month { opacity: 0.4; }

        .day-number {
            font-size: 20px;
            font-weight: 700;
            color: #5a4a3a;
            line-height: 1;
            margin-bottom: 5px;
        }
        .day-card.today .day-number {
            background: #ff6b6b;
            color: white;
            width: 30px; height: 30px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 15px;
        }

        /* ‚îÄ‚îÄ Tasks ‚îÄ‚îÄ */
        .tasks { display: flex; flex-direction: column; gap: 3px; }

        .task-item {
            display: flex;
            align-items: flex-start;
            gap: 4px;
            font-size: 12px;
            line-height: 1.3;
            color: #4a3a2a;
            position: relative;
            group: task;
        }

        .task-check {
            width: 13px; height: 13px;
            border: 1.5px solid #bbb;
            border-radius: 2px;
            flex-shrink: 0;
            margin-top: 1px;
            cursor: pointer;
            position: relative;
            transform: rotate(-1deg);
            transition: all 0.15s;
        }
        .task-check:hover { border-color: #5cb85c; }
        .task-check.done { border-color: #5cb85c; background: #5cb85c; }
        .task-check.done::after {
            content: '‚úì';
            position: absolute;
            top: -2px; left: 1px;
            font-size: 11px; color: white; font-weight: bold;
        }

        .dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; margin-top: 4px; }
        .dot-red    { background: #ff6b6b; }
        .dot-orange { background: #ffa94d; }
        .dot-blue   { background: #74b9ff; }

        .task-text { flex: 1; word-break: break-word; cursor: pointer; }
        .task-text:hover { opacity: 0.7; }
        .task-text.done-text { text-decoration: line-through; color: #bbb; }

        .highlight-yellow { background: rgba(255,235,100,0.6); padding: 0 2px; border-radius: 2px; }
        .highlight-pink   { background: rgba(255,180,180,0.5); padding: 0 2px; border-radius: 2px; }
        .highlight-mint   { background: rgba(150,230,200,0.5); padding: 0 2px; border-radius: 2px; }
        .highlight-blue   { background: rgba(150,200,255,0.5); padding: 0 2px; border-radius: 2px; }

        /* task action buttons (edit/delete) */
        .task-actions {
            display: none;
            gap: 2px;
            flex-shrink: 0;
        }
        .task-item:hover .task-actions { display: flex; }

        .task-act-btn {
            width: 18px; height: 18px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.15s;
            background: transparent;
        }
        .btn-edit-task  { color: #74b9ff; }
        .btn-edit-task:hover  { background: #74b9ff; color: white; }
        .btn-del-task   { color: #ff6b6b; }
        .btn-del-task:hover   { background: #ff6b6b; color: white; }

        /* add button */
        .add-btn {
            font-family: 'Caveat', cursive;
            font-size: 16px;
            color: #ccc;
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            margin-top: 3px;
            transition: color 0.2s;
            display: block;
        }
        .add-btn:hover { color: #ff9a9e; }

        /* task count badge */
        .task-count {
            position: absolute;
            top: 5px; right: 5px;
            background: #ff9a9e;
            color: white;
            font-size: 10px;
            padding: 1px 5px;
            border-radius: 10px;
            line-height: 1.4;
            display: none;
        }
        .task-count.show { display: block; }

        /* ‚îÄ‚îÄ Legend ‚îÄ‚îÄ */
        .legend {
            display: flex;
            gap: 16px;
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px dashed #d4c9b0;
            flex-wrap: wrap;
            position: relative;
            z-index: 1;
            align-items: center;
        }
        .legend-item {
            display: flex; align-items: center; gap: 5px;
            font-size: 13px; color: #999;
        }
        .legend-hl { padding: 1px 6px; font-size: 12px; border-radius: 2px; }

        .stats {
            margin-left: auto;
            font-size: 13px;
            color: #aaa;
        }
        .stats span { color: #ff9a9e; font-weight: 600; }

        /* ‚îÄ‚îÄ Modal ‚îÄ‚îÄ */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.25);
            z-index: 200;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(2px);
        }
        .modal-overlay.show { display: flex; }

        .modal {
            background: #fffef9;
            padding: 26px 28px;
            border-radius: 4px;
            width: 340px;
            font-family: 'Caveat', cursive;
            box-shadow: 6px 6px 0 #d4c9b0, 0 20px 40px rgba(0,0,0,0.15);
            position: relative;
            transform: rotate(-0.5deg);
            animation: popIn 0.2s ease;
        }
        @keyframes popIn {
            from { transform: rotate(-0.5deg) scale(0.92); opacity: 0; }
            to   { transform: rotate(-0.5deg) scale(1);    opacity: 1; }
        }

        /* tape on modal */
        .modal::before {
            content: '';
            position: absolute;
            top: -10px; left: 50%; transform: translateX(-50%);
            width: 60px; height: 20px;
            background: repeating-linear-gradient(45deg,rgba(255,154,158,0.5),rgba(255,154,158,0.5) 4px,rgba(254,207,239,0.5) 4px,rgba(254,207,239,0.5) 8px);
            border-radius: 2px;
        }

        .modal-header {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 18px;
        }
        .modal h3 { font-size: 22px; color: #5a4a3a; }
        .modal-date-label { font-size: 13px; color: #aaa; }

        .modal label {
            font-size: 14px; color: #8b7b6a;
            display: block; margin-bottom: 4px; margin-top: 10px;
        }
        .modal label:first-of-type { margin-top: 0; }

        .modal input[type="text"],
        .modal input[type="time"],
        .modal select,
        .modal textarea {
            font-family: 'Caveat', cursive;
            font-size: 16px;
            width: 100%;
            padding: 8px 10px;
            border: 1.5px solid #d4c9b0;
            border-radius: 3px;
            background: #fffef9;
            color: #4a3a2a;
            transition: border-color 0.2s;
            resize: none;
        }
        .modal input:focus, .modal select:focus, .modal textarea:focus {
            outline: none;
            border-color: #ff9a9e;
        }

        .modal-row { display: flex; gap: 10px; }
        .modal-row > div { flex: 1; }

        .modal-btns {
            display: flex; gap: 10px; justify-content: flex-end;
            margin-top: 18px;
        }
        .btn-save {
            font-family: 'Caveat', cursive;
            font-size: 16px;
            padding: 7px 22px;
            background: #ff9a9e;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            box-shadow: 2px 2px 0 #e07b7b;
            transition: all 0.15s;
        }
        .btn-save:hover { background: #e07b7b; transform: translateY(-1px); }
        .btn-cancel {
            font-family: 'Caveat', cursive;
            font-size: 16px;
            padding: 7px 16px;
            background: none;
            border: 1.5px solid #d4c9b0;
            border-radius: 3px;
            cursor: pointer;
            color: #aaa;
            transition: all 0.15s;
        }
        .btn-cancel:hover { border-color: #aaa; color: #666; }

        /* ‚îÄ‚îÄ Highlight picker ‚îÄ‚îÄ */
        .hl-picker { display: flex; gap: 8px; margin-top: 4px; }
        .hl-opt {
            width: 28px; height: 20px;
            border-radius: 3px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: transform 0.15s, border-color 0.15s;
        }
        .hl-opt:hover { transform: scale(1.15); }
        .hl-opt.selected { border-color: #5a4a3a; transform: scale(1.15); }
        .hl-none   { background: #f0ebe0; }
        .hl-yellow { background: rgba(255,235,100,0.8); }
        .hl-pink   { background: rgba(255,180,180,0.8); }
        .hl-mint   { background: rgba(150,230,200,0.8); }
        .hl-blue   { background: rgba(150,200,255,0.8); }

        /* ‚îÄ‚îÄ Confirm delete ‚îÄ‚îÄ */
        .confirm-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.2);
            z-index: 300;
            align-items: center;
            justify-content: center;
        }
        .confirm-overlay.show { display: flex; }
        .confirm-box {
            background: #fffef9;
            padding: 24px 28px;
            border-radius: 4px;
            font-family: 'Caveat', cursive;
            box-shadow: 4px 4px 0 #d4c9b0;
            text-align: center;
            animation: popIn 0.15s ease;
        }
        .confirm-box p { font-size: 18px; color: #5a4a3a; margin-bottom: 16px; }
        .confirm-box p span { color: #ff6b6b; }
        .confirm-btns { display: flex; gap: 10px; justify-content: center; }
        .btn-confirm-del {
            font-family: 'Caveat', cursive;
            font-size: 16px;
            padding: 6px 20px;
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .btn-confirm-cancel {
            font-family: 'Caveat', cursive;
            font-size: 16px;
            padding: 6px 16px;
            background: none;
            border: 1.5px solid #d4c9b0;
            border-radius: 3px;
            cursor: pointer;
            color: #aaa;
        }

        /* ‚îÄ‚îÄ Toast ‚îÄ‚îÄ */
        .toast {
            position: fixed;
            bottom: 30px; left: 50%;
            transform: translateX(-50%) translateY(20px);
            background: #5a4a3a;
            color: #fffef9;
            font-family: 'Caveat', cursive;
            font-size: 16px;
            padding: 10px 24px;
            border-radius: 20px;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s;
            z-index: 500;
            white-space: nowrap;
        }
        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .doodle {
            position: absolute;
            opacity: 0.12;
            pointer-events: none;
            z-index: 0;
        }

        /* responsive */
        @media (max-width: 640px) {
            .calendar-grid { gap: 4px; }
            .day-card { min-height: 80px; padding: 4px; }
            .day-number { font-size: 16px; }
            .task-item { font-size: 10px; }
            .modal { width: calc(100vw - 40px); }
        }
    </style>
</head>
<body>

<div class="notebook">
    <div class="spiral"></div>
    <div class="washi washi-1"></div>
    <div class="washi washi-2"></div>

    <div class="doodle" style="bottom:80px;right:60px;font-size:40px;transform:rotate(15deg)">‚úø</div>
    <div class="doodle" style="bottom:200px;right:28px;font-size:28px;transform:rotate(-10deg)">‚òÖ</div>
    <div class="doodle" style="top:200px;right:20px;font-size:22px;transform:rotate(5deg)">‚ô°</div>

    <div class="content">
        <!-- Header -->
        <div class="header">
            <div style="display:flex;gap:6px;align-items:center">
                <button class="nav-btn" id="prevBtn" title="‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô">‚Äπ</button>
                <button class="today-btn" id="todayBtn">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
                <button class="nav-btn" id="nextBtn" title="‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ">‚Ä∫</button>
            </div>

            <div class="header-center">
                <div class="month-banner">
                    <div class="month-title" id="monthTitle">‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°</div>
                </div>
                <div class="year-tag" id="yearTag">2025 ‚ú¶ my planner</div>
            </div>

            <div style="width:120px"></div>
        </div>

        <!-- Grid -->
        <div class="calendar-grid" id="calendarGrid">
            <div class="day-header weekend">‡∏≠‡∏≤</div>
            <div class="day-header">‡∏à</div>
            <div class="day-header">‡∏≠</div>
            <div class="day-header">‡∏û</div>
            <div class="day-header">‡∏û‡∏§</div>
            <div class="day-header">‡∏®</div>
            <div class="day-header weekend">‡∏™</div>
        </div>

        <!-- Legend -->
        <div class="legend">
            <div class="legend-item"><span class="dot dot-red"></span>‡∏î‡πà‡∏ß‡∏ô‡∏°‡∏≤‡∏Å</div>
            <div class="legend-item"><span class="dot dot-orange"></span>‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á</div>
            <div class="legend-item"><span class="dot dot-blue"></span>‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</div>
            <div class="legend-item">
                <span class="legend-hl" style="background:rgba(255,235,100,0.7)">‡πÑ‡∏Æ‡πÑ‡∏•‡∏ï‡πå</span>
            </div>
            <div class="stats" id="statsText"></div>
        </div>
    </div>
</div>

<!-- ‚îÄ‚îÄ ADD / EDIT Modal ‚îÄ‚îÄ -->
<div class="modal-overlay" id="modalOverlay">
    <div class="modal">
        <div class="modal-header">
            <h3 id="modalTitle">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à</h3>
            <span class="modal-date-label" id="modalDateLabel"></span>
        </div>

        <label>üìù ‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à</label>
        <input type="text" id="taskInput" placeholder="‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à..." maxlength="40" autocomplete="off">

        <label>üìì ‡πÇ‡∏ô‡πâ‡∏ï (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</label>
        <textarea id="taskNote" rows="2" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°..."></textarea>

        <div class="modal-row">
            <div>
                <label>‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤</label>
                <input type="time" id="taskTime">
            </div>
            <div>
                <label>üî¥ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</label>
                <select id="prioritySelect">
                    <option value="blue">üîµ ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</option>
                    <option value="orange">üü† ‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á</option>
                    <option value="red">üî¥ ‡∏î‡πà‡∏ß‡∏ô‡∏°‡∏≤‡∏Å</option>
                </select>
            </div>
        </div>

        <label>üé® ‡πÑ‡∏Æ‡πÑ‡∏•‡∏ï‡πå</label>
        <div class="hl-picker">
            <div class="hl-opt hl-none selected" data-hl="" title="‡πÑ‡∏°‡πà highlight"></div>
            <div class="hl-opt hl-yellow" data-hl="highlight-yellow" title="‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á"></div>
            <div class="hl-opt hl-pink"   data-hl="highlight-pink"   title="‡∏ä‡∏°‡∏û‡∏π"></div>
            <div class="hl-opt hl-mint"   data-hl="highlight-mint"   title="‡∏°‡∏¥‡πâ‡∏ô‡∏ï‡πå"></div>
            <div class="hl-opt hl-blue"   data-hl="highlight-blue"   title="‡∏ü‡πâ‡∏≤"></div>
        </div>

        <div class="modal-btns">
            <button class="btn-cancel" onclick="closeModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            <button class="btn-save"   onclick="saveTask()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ‚úì</button>
        </div>
    </div>
</div>

<!-- ‚îÄ‚îÄ Confirm Delete ‚îÄ‚îÄ -->
<div class="confirm-overlay" id="confirmOverlay">
    <div class="confirm-box">
        <p>‡∏•‡∏ö‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à <span id="confirmTaskName"></span> ?</p>
        <div class="confirm-btns">
            <button class="btn-confirm-cancel" onclick="closeConfirm()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            <button class="btn-confirm-del"    onclick="confirmDelete()">‡∏•‡∏ö‡πÄ‡∏•‡∏¢ üóëÔ∏è</button>
        </div>
    </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
const MONTHS_TH = ['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°','‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå','‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°','‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô','‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°','‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô',
                   '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°','‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°','‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô','‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°','‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô','‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'];

let currentDate = new Date();
let tasks = JSON.parse(localStorage.getItem('plannerTasks_v2') || '{}');

// modal state
let modalMode  = 'add';   // 'add' | 'edit'
let modalKey   = '';
let editIndex  = -1;
let selectedHl = '';

// confirm delete state
let deleteKey   = '';
let deleteIndex = -1;

/* ‚îÄ‚îÄ Storage ‚îÄ‚îÄ */
function saveTasks() {
    localStorage.setItem('plannerTasks_v2', JSON.stringify(tasks));
}

function getDateKey(y, m, d) {
    return `${y}-${String(m + 1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
}

/* ‚îÄ‚îÄ Toast ‚îÄ‚îÄ */
function showToast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 2200);
}

/* ‚îÄ‚îÄ Render ‚îÄ‚îÄ */
function renderCalendar() {
    const y = currentDate.getFullYear();
    const m = currentDate.getMonth();
    const today = new Date();

    document.getElementById('monthTitle').textContent = MONTHS_TH[m];
    document.getElementById('yearTag').textContent    = `${y} ‚ú¶ my planner`;

    const grid = document.getElementById('calendarGrid');
    grid.querySelectorAll('.day-card').forEach(c => c.remove());

    const firstDay    = new Date(y, m, 1).getDay();
    const daysInMonth = new Date(y, m + 1, 0).getDate();
    const prevDays    = new Date(y, m, 0).getDate();

    // prev month
    for (let i = firstDay - 1; i >= 0; i--) {
        grid.appendChild(createDayCard(y, m - 1, prevDays - i, true));
    }
    // current month
    for (let d = 1; d <= daysInMonth; d++) {
        const isToday   = d === today.getDate() && m === today.getMonth() && y === today.getFullYear();
        const isWeekend = [0, 6].includes(new Date(y, m, d).getDay());
        grid.appendChild(createDayCard(y, m, d, false, isToday, isWeekend));
    }
    // next month fill
    const filled    = grid.querySelectorAll('.day-card').length;
    const remaining = filled % 7 === 0 ? 0 : 7 - (filled % 7);
    for (let d = 1; d <= remaining; d++) {
        grid.appendChild(createDayCard(y, m + 1, d, true));
    }

    updateStats();
}

function createDayCard(y, m, d, otherMonth, isToday = false, isWeekend = false) {
    const card = document.createElement('div');
    card.className = `day-card${isToday ? ' today' : ''}${isWeekend ? ' weekend' : ''}${otherMonth ? ' other-month' : ''}`;

    // number
    const numDiv = document.createElement('div');
    numDiv.className = 'day-number';
    numDiv.textContent = d;
    card.appendChild(numDiv);

    const key      = getDateKey(y, m, d);
    const dayTasks = tasks[key] || [];

    // task count badge
    const badge = document.createElement('div');
    badge.className = `task-count${dayTasks.length > 0 ? ' show' : ''}`;
    badge.textContent = dayTasks.length;
    card.appendChild(badge);

    // tasks
    const tasksDiv = document.createElement('div');
    tasksDiv.className = 'tasks';
    dayTasks.forEach((t, i) => tasksDiv.appendChild(createTaskEl(t, key, i)));
    card.appendChild(tasksDiv);

    // add button
    if (!otherMonth) {
        const addBtn = document.createElement('button');
        addBtn.className = 'add-btn';
        addBtn.title     = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à';
        addBtn.textContent = '+ ‡πÄ‡∏û‡∏¥‡πà‡∏°';
        addBtn.onclick = e => {
            e.stopPropagation();
            openModal('add', key, `${d} ${MONTHS_TH[m]} ${y}`);
        };
        card.appendChild(addBtn);
    }

    return card;
}

function createTaskEl(task, key, index) {
    const item = document.createElement('div');
    item.className = 'task-item';

    // checkbox
    const check = document.createElement('div');
    check.className = `task-check${task.done ? ' done' : ''}`;
    check.title     = task.done ? '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' : '‡∏ó‡∏≥‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß';
    check.onclick   = () => toggleTask(key, index);

    // priority dot
    const dot = document.createElement('div');
    dot.className = `dot dot-${task.priority || 'blue'}`;

    // text + time
    const text = document.createElement('span');
    text.className = `task-text${task.done ? ' done-text' : ''}${task.highlight ? ' ' + task.highlight : ''}`;
    text.innerHTML = (task.time ? `<small style="color:#bbb;margin-right:2px">${task.time}</small>` : '') + escHtml(task.text);
    text.title     = task.note || '';
    text.onclick   = () => openModal('edit', key, '', index);

    // action buttons
    const actions = document.createElement('div');
    actions.className = 'task-actions';

    const editBtn = document.createElement('button');
    editBtn.className = 'task-act-btn btn-edit-task';
    editBtn.title     = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç';
    editBtn.textContent = '‚úèÔ∏è';
    editBtn.onclick = e => { e.stopPropagation(); openModal('edit', key, '', index); };

    const delBtn = document.createElement('button');
    delBtn.className = 'task-act-btn btn-del-task';
    delBtn.title     = '‡∏•‡∏ö';
    delBtn.textContent = 'üóëÔ∏è';
    delBtn.onclick = e => { e.stopPropagation(); openConfirm(key, index, task.text); };

    actions.appendChild(editBtn);
    actions.appendChild(delBtn);

    item.appendChild(check);
    item.appendChild(dot);
    item.appendChild(text);
    item.appendChild(actions);
    return item;
}

function escHtml(str) {
    return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

/* ‚îÄ‚îÄ Toggle done ‚îÄ‚îÄ */
function toggleTask(key, index) {
    if (!tasks[key]) return;
    tasks[key][index].done = !tasks[key][index].done;
    saveTasks();
    renderCalendar();
    showToast(tasks[key][index].done ? '‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!' : '‚Ü©Ô∏è ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
}

/* ‚îÄ‚îÄ Stats ‚îÄ‚îÄ */
function updateStats() {
    let total = 0, done = 0;
    Object.values(tasks).forEach(arr => {
        total += arr.length;
        done  += arr.filter(t => t.done).length;
    });
    document.getElementById('statsText').innerHTML =
        `‡∏£‡∏ß‡∏° <span>${total}</span> ‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à ¬∑ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à <span>${done}</span>`;
}

/* ‚îÄ‚îÄ Modal ‚îÄ‚îÄ */
function openModal(mode, key, dateLabel = '', idx = -1) {
    modalMode  = mode;
    modalKey   = key;
    editIndex  = idx;

    const overlay = document.getElementById('modalOverlay');

    if (mode === 'add') {
        document.getElementById('modalTitle').textContent     = '+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à';
        document.getElementById('modalDateLabel').textContent = dateLabel;
        document.getElementById('taskInput').value   = '';
        document.getElementById('taskNote').value    = '';
        document.getElementById('taskTime').value    = '';
        document.getElementById('prioritySelect').value = 'blue';
        setHlPicker('');
    } else {
        const t = (tasks[key] || [])[idx];
        if (!t) return;
        document.getElementById('modalTitle').textContent     = '‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à';
        document.getElementById('modalDateLabel').textContent = '';
        document.getElementById('taskInput').value   = t.text;
        document.getElementById('taskNote').value    = t.note || '';
        document.getElementById('taskTime').value    = t.time || '';
        document.getElementById('prioritySelect').value = t.priority || 'blue';
        setHlPicker(t.highlight || '');
    }

    overlay.classList.add('show');
    setTimeout(() => document.getElementById('taskInput').focus(), 100);
}

function closeModal() {
    document.getElementById('modalOverlay').classList.remove('show');
}

function setHlPicker(val) {
    selectedHl = val;
    document.querySelectorAll('.hl-opt').forEach(el => {
        el.classList.toggle('selected', el.dataset.hl === val);
    });
}

document.querySelectorAll('.hl-opt').forEach(el => {
    el.addEventListener('click', () => setHlPicker(el.dataset.hl));
});

function saveTask() {
    const text = document.getElementById('taskInput').value.trim();
    if (!text) {
        document.getElementById('taskInput').focus();
        return;
    }

    const taskObj = {
        text,
        note:      document.getElementById('taskNote').value.trim(),
        time:      document.getElementById('taskTime').value,
        priority:  document.getElementById('prioritySelect').value,
        highlight: selectedHl,
        done:      false,
    };

    if (modalMode === 'add') {
        if (!tasks[modalKey]) tasks[modalKey] = [];
        tasks[modalKey].push(taskObj);
        showToast('üìù ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡πÅ‡∏•‡πâ‡∏ß!');
    } else {
        // keep done state
        const prevDone = (tasks[modalKey][editIndex] || {}).done || false;
        taskObj.done   = prevDone;
        tasks[modalKey][editIndex] = taskObj;
        showToast('‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!');
    }

    saveTasks();
    closeModal();
    renderCalendar();
}

/* ‚îÄ‚îÄ Confirm Delete ‚îÄ‚îÄ */
function openConfirm(key, index, name) {
    deleteKey   = key;
    deleteIndex = index;
    document.getElementById('confirmTaskName').textContent = `"${name}"`;
    document.getElementById('confirmOverlay').classList.add('show');
}
function closeConfirm() {
    document.getElementById('confirmOverlay').classList.remove('show');
}
function confirmDelete() {
    if (!tasks[deleteKey]) return;
    tasks[deleteKey].splice(deleteIndex, 1);
    if (tasks[deleteKey].length === 0) delete tasks[deleteKey];
    saveTasks();
    closeConfirm();
    renderCalendar();
    showToast('üóëÔ∏è ‡∏•‡∏ö‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡πÅ‡∏•‡πâ‡∏ß');
}

/* ‚îÄ‚îÄ Keyboard ‚îÄ‚îÄ */
document.addEventListener('keydown', e => {
    if (e.key === 'Escape') { closeModal(); closeConfirm(); }
    if (e.key === 'Enter' && document.getElementById('modalOverlay').classList.contains('show')) {
        if (document.activeElement.tagName !== 'TEXTAREA') saveTask();
    }
});

/* click outside modal */
document.getElementById('modalOverlay').addEventListener('click', e => {
    if (e.target === document.getElementById('modalOverlay')) closeModal();
});
document.getElementById('confirmOverlay').addEventListener('click', e => {
    if (e.target === document.getElementById('confirmOverlay')) closeConfirm();
});

/* ‚îÄ‚îÄ Nav ‚îÄ‚îÄ */
document.getElementById('prevBtn').onclick = () => {
    currentDate.setMonth(currentDate.getMonth() - 1);
    renderCalendar();
};
document.getElementById('nextBtn').onclick = () => {
    currentDate.setMonth(currentDate.getMonth() + 1);
    renderCalendar();
};
document.getElementById('todayBtn').onclick = () => {
    currentDate = new Date();
    renderCalendar();
};

/* ‚îÄ‚îÄ Seed sample ‚îÄ‚îÄ */
function seedSample() {
    const y = currentDate.getFullYear();
    const m = currentDate.getMonth();
    const d = currentDate.getDate();
    const sample = {
        [getDateKey(y, m, d)]: [
            { text:'‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏ó‡∏µ‡∏°', time:'10:00', priority:'red',    highlight:'highlight-yellow', note:'‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° A', done:false },
            { text:'‡∏™‡πà‡∏á report',time:'',      priority:'orange', highlight:'',                 note:'',              done:true  },
            { text:'‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á',   time:'',      priority:'blue',   highlight:'',                 note:'‡∏ô‡∏° ‡∏Ç‡∏ô‡∏°‡∏õ‡∏±‡∏á',    done:false },
        ],
        [getDateKey(y, m, d+1)]: [
            { text:'‡∏´‡∏°‡∏≠‡∏ü‡∏±‡∏ô',   time:'14:00', priority:'red',    highlight:'highlight-pink', note:'‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û', done:false },
            { text:'‡∏≠‡πà‡∏≤‡∏ô‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠',time:'',    priority:'blue',   highlight:'',               note:'',              done:false },
        ],
        [getDateKey(y, m, d+3)]: [
            { text:'‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô üéÇ', time:'19:00', priority:'orange', highlight:'highlight-mint', note:'‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç‡∏î‡πâ‡∏ß‡∏¢', done:false },
        ],
    };
    Object.entries(sample).forEach(([k, v]) => { if (!tasks[k]) tasks[k] = v; });
    saveTasks();
}

seedSample();
renderCalendar();
</script>
</body>
</html>
